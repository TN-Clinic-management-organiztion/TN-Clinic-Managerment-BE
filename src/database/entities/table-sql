CREATE TABLE IF NOT EXISTS org_rooms (
    room_id SERIAL PRIMARY KEY,
    room_name VARCHAR(100) NOT NULL,
    room_type VARCHAR(50) CHECK (room_type IN ('CLINIC', 'PARACLINICAL', 'PHARMACY', 'CASHIER', 'ADMIN')),
    is_active BOOLEAN DEFAULT TRUE
);

-- ROLES
CREATE TABLE IF NOT EXISTS sys_roles (
    role_id SERIAL PRIMARY KEY,
    role_code VARCHAR(50) UNIQUE NOT NULL,
    role_name VARCHAR(100),
    description TEXT
);

-- USERS
CREATE TABLE IF NOT EXISTS sys_users (
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(100) UNIQUE,
    password VARCHAR(255),
    email VARCHAR(150),
    phone VARCHAR(20),
    cccd VARCHAR(12) UNIQUE,
    is_active BOOLEAN DEFAULT TRUE,
    refresh_token_hash VARCHAR(255),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
);

-- SPECIALTIES
CREATE TABLE IF NOT EXISTS ref_specialties (
    specialty_id SERIAL PRIMARY KEY,
    specialty_code VARCHAR(50) UNIQUE NOT NULL,
    specialty_name VARCHAR(255) NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE
);

-- ICD10 (MUST be before medical_encounters)
CREATE TABLE IF NOT EXISTS ref_icd10 (
    icd_code VARCHAR(10) PRIMARY KEY,
    name_vi VARCHAR(500) NOT NULL,
    name_en VARCHAR(500),
    parent_code VARCHAR(10) REFERENCES ref_icd10(icd_code),
    level INT,
    is_leaf BOOLEAN DEFAULT FALSE,
    active BOOLEAN DEFAULT TRUE
);

-- STAFF PROFILES (FIX: missing comma after role_id)
CREATE TABLE IF NOT EXISTS staff_profiles (
    staff_id UUID PRIMARY KEY REFERENCES sys_users(user_id),
    full_name VARCHAR(255) NOT NULL,
    role_id INT NOT NULL REFERENCES sys_roles(role_id),
    assigned_room_id INT REFERENCES org_rooms(room_id),
    signature_url VARCHAR(500),
    specialty_id INT REFERENCES ref_specialties(specialty_id),
    deleted_at TIMESTAMPTZ
);

-- PATIENT PROFILES
CREATE TABLE IF NOT EXISTS patient_profiles (
    patient_id UUID PRIMARY KEY REFERENCES sys_users(user_id),
    full_name VARCHAR(255) NOT NULL,
    dob DATE NOT NULL,
    gender VARCHAR(10) CHECK (gender IN ('NAM', 'NU', 'KHAC')),
    address TEXT,
    medical_history TEXT,
    allergy_history TEXT,
    deleted_at TIMESTAMPTZ
);

-- QUEUE COUNTERS
CREATE TABLE IF NOT EXISTS queue_counters (
    counter_id SERIAL PRIMARY KEY,
    room_id INT NOT NULL REFERENCES org_rooms(room_id),
    ticket_type VARCHAR(20) NOT NULL CHECK (ticket_type IN ('REGISTRATION', 'CONSULTATION', 'SERVICE')),
    last_number INT DEFAULT 0,
    reset_date DATE DEFAULT CURRENT_DATE,
    UNIQUE(room_id, ticket_type, reset_date)
);

-- MEDICAL ENCOUNTERS
CREATE TABLE IF NOT EXISTS medical_encounters (
    encounter_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID REFERENCES patient_profiles(patient_id),
    doctor_id UUID REFERENCES staff_profiles(staff_id),
    assigned_room_id INT REFERENCES org_rooms(room_id),
    visit_date TIMESTAMPTZ DEFAULT NOW(),
    current_status VARCHAR(50) DEFAULT 'REGISTERED' CHECK (current_status IN (
        'REGISTERED', 'AWAITING_PAYMENT', 'IN_CONSULTATION',
        'AWAITING_CLS', 'IN_CLS', 'CLS_COMPLETED', 'RESULTS_READY', 'COMPLETED'
    )),
    initial_symptoms TEXT,

    weight NUMERIC(5,2),
    height NUMERIC(5,2),
    bmi NUMERIC(4,2),
    temperature NUMERIC(4,1),
    pulse INT,
    respiratory_rate INT,
    bp_systolic INT,
    bp_diastolic INT,
    sp_o2 NUMERIC(5,2),

    final_icd_code VARCHAR(10) REFERENCES ref_icd10(icd_code),
    doctor_conclusion TEXT,
    deleted_at TIMESTAMPTZ
);

-- QUEUE TICKETS
CREATE TABLE IF NOT EXISTS queue_tickets (
    ticket_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    encounter_id UUID REFERENCES medical_encounters(encounter_id),
    room_id INT NOT NULL REFERENCES org_rooms(room_id),
    ticket_type VARCHAR(20) NOT NULL CHECK (ticket_type IN ('REGISTRATION', 'CONSULTATION', 'SERVICE')),
    display_number INT NOT NULL,
    source VARCHAR(20) DEFAULT 'WALKIN' CHECK (source IN ('ONLINE', 'WALKIN')),
    status VARCHAR(20) NOT NULL DEFAULT 'WAITING'
        CHECK (status IN ('WAITING', 'CALLED', 'IN_PROGRESS', 'COMPLETED', 'SKIPPED')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    called_at TIMESTAMPTZ,
    started_at TIMESTAMPTZ,
    service_ids INT[],
    completed_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_queue_tickets_service_ids
ON queue_tickets USING GIN(service_ids);

-- SERVICE CATEGORIES
CREATE TABLE IF NOT EXISTS ref_service_categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(255) NOT NULL,
    parent_id INT REFERENCES ref_service_categories(category_id),
    is_system_root BOOLEAN DEFAULT FALSE
);

-- SERVICES (NO result_input_type) + FIX: remove trailing comma
CREATE TABLE IF NOT EXISTS ref_services (
    service_id SERIAL PRIMARY KEY,
    category_id INT REFERENCES ref_service_categories(category_id),
    service_name VARCHAR(255) NOT NULL,
    unit_price DECIMAL(15,2)
);

-- ROOM_SERVICES
CREATE TABLE IF NOT EXISTS room_services (
    room_id INT REFERENCES org_rooms(room_id),
    service_id INT REFERENCES ref_services(service_id),
    PRIMARY KEY (room_id, service_id)
);

-- SERVICE REQUESTS
CREATE TABLE IF NOT EXISTS service_requests (
    request_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    encounter_id UUID REFERENCES medical_encounters(encounter_id),
    requesting_doctor_id UUID REFERENCES staff_profiles(staff_id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    notes TEXT,
    deleted_at TIMESTAMPTZ
);

-- SERVICE REQUEST ITEMS + FIX: remove trailing comma
CREATE TABLE IF NOT EXISTS service_request_items (
    item_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    request_id UUID REFERENCES service_requests(request_id),
    service_id INT REFERENCES ref_services(service_id)
);

-- SERVICE RESULTS
CREATE TABLE IF NOT EXISTS service_results (
    result_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    request_item_id UUID REFERENCES service_request_items(item_id),
    technician_id UUID REFERENCES staff_profiles(staff_id),
    main_conclusion TEXT,
    report_body_html TEXT,
    is_abnormal BOOLEAN DEFAULT FALSE,
    result_time TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
);

-- RESULT IMAGES
CREATE TABLE IF NOT EXISTS result_images (
    image_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    result_id UUID REFERENCES service_results(result_id),
    public_id VARCHAR(255),
    original_image_url VARCHAR(500) NOT NULL,
    file_name VARCHAR(255),
    file_size BIGINT,
    mime_type VARCHAR(100),
    image_width INT,
    imgae_height INT,
    uploaded_at TIMESTAMPTZ DEFAULT NOW(),
    uploaded_by UUID NOT NULL REFERENCES staff_profiles(staff_id)
);

-- ANNOTATION
CREATE TABLE IF NOT EXISTS annotation_projects (
    project_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    task_type VARCHAR(50) NOT NULL CHECK (task_type IN (
        'CLASSIFICATION','BOUNDING_BOX','SEGMENTATION','KEYPOINT','OCR','OTHER'
    )),
    is_active BOOLEAN DEFAULT TRUE,
    created_by UUID REFERENCES staff_profiles(staff_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS image_annotations (
    annotation_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    image_id UUID NOT NULL REFERENCES result_images(image_id),
    annotation_source VARCHAR(20) NOT NULL CHECK (annotation_source IN ('AI', 'HUMAN')),
    annotation_data JSONB NOT NULL,
    ai_model_name VARCHAR(100),
    ai_model_version VARCHAR(50),
    labeled_by UUID REFERENCES staff_profiles(staff_id),
    labeled_at TIMESTAMPTZ DEFAULT NOW(),
    approved_by UUID REFERENCES staff_profiles(staff_id),
    approved_at TIMESTAMPTZ,
    annotation_status VARCHAR(20) DEFAULT 'IN_PROGRESS'
        CHECK (annotation_status IN ('IN_PROGRESS','SUBMITTED','APPROVED','REJECTED','DEPRECATED')),
    rejection_reason TEXT,
    deprecation_reason TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS annotation_project_images (
    project_id UUID NOT NULL REFERENCES annotation_projects(project_id),
    image_id UUID NOT NULL REFERENCES result_images(image_id),
    added_by UUID REFERENCES staff_profiles(staff_id),
    added_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (project_id, image_id)
);