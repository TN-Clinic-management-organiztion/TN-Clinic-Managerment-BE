-- BẢNG CƠ BẢN & NGƯỜI DÙNG
CREATE TABLE org_rooms (
    room_id SERIAL PRIMARY KEY,
    room_name VARCHAR(100) NOT NULL,
    room_type VARCHAR(50) CHECK (room_type IN ('CLINIC', 'PARACLINICAL', 'PHARMACY', 'CASHIER', 'ADMIN')),
    is_active BOOLEAN DEFAULT TRUE
); -- Done

CREATE TABLE sys_roles (
    role_id SERIAL PRIMARY KEY,
    role_code VARCHAR(50) UNIQUE NOT NULL,
    role_name VARCHAR(100),
    description TEXT
); -- Done

CREATE TABLE sys_users (
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(100) UNIQUE,
    password VARCHAR(255),
    email VARCHAR(150),
    phone VARCHAR(20),
    cccd VARCHAR(12) UNIQUE,
    is_active BOOLEAN DEFAULT TRUE,
    refresh_token_hash VARCHAR(255),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
); -- Done

CREATE TABLE ref_specialties (
    specialty_id SERIAL PRIMARY KEY,
    specialty_code VARCHAR(50) UNIQUE NOT NULL,
    specialty_name VARCHAR(255) NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE
); -- Done

CREATE TABLE staff_profiles (
    staff_id UUID PRIMARY KEY REFERENCES sys_users(user_id),
    full_name VARCHAR(255) NOT NULL,
    role_id INT NOT NULL REFERENCES sys_roles(role_id)
    assigned_room_id INT REFERENCES org_rooms(room_id),
    signature_url VARCHAR(500),
    specialty_id INT REFERENCES ref_specialties(specialty_id),
	  deleted_at TIMESTAMPTZ
); -- Done

CREATE TABLE patient_profiles (
    patient_id UUID PRIMARY KEY REFERENCES sys_users(user_id),
    full_name VARCHAR(255) NOT NULL,
    dob DATE NOT NULL,
    gender VARCHAR(10) CHECK (gender IN ('NAM', 'NU', 'KHAC')),
    address TEXT,
    medical_history TEXT,
    allergy_history TEXT,
	  deleted_at TIMESTAMPTZ
); -- Done

-- BẢNG HÀNG ĐỢI
CREATE TABLE queue_counters (
    counter_id SERIAL PRIMARY KEY,
    room_id INT NOT NULL REFERENCES org_rooms(room_id),
    ticket_type VARCHAR(20) NOT NULL CHECK (ticket_type IN ('REGISTRATION', 'CONSULTATION', 'SERVICE')),
    last_number INT DEFAULT 0,
    reset_date DATE DEFAULT CURRENT_DATE,
    UNIQUE(room_id, ticket_type, reset_date)
); -- Done

-- BẢNG LƯỢT KHÁM & THEO DÕI
CREATE TABLE medical_encounters (
    encounter_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID REFERENCES patient_profiles(patient_id),
    doctor_id UUID REFERENCES staff_profiles(staff_id),
    assigned_room_id INT REFERENCES org_rooms(room_id),
    visit_date TIMESTAMPTZ DEFAULT NOW(),
    current_status VARCHAR(50) DEFAULT 'REGISTERED' CHECK (current_status IN (
        'REGISTERED', 'AWAITING_PAYMENT', 'IN_CONSULTATION', 
        'AWAITING_CLS', 'IN_CLS', 'CLS_COMPLETED', 'RESULTS_READY', 'COMPLETED'
    )),
    initial_symptoms TEXT,

    weight NUMERIC(5,2),        -- Cân nặng (kg), ví dụ: 65.50
    height NUMERIC(5,2),        -- Chiều cao (cm), ví dụ: 170.5
    bmi NUMERIC(4,2),           -- Chỉ số khối cơ thể (tự tính hoặc lưu cứng)
    temperature NUMERIC(4,1),   -- Nhiệt độ (°C), ví dụ: 37.5
    pulse INT,                  -- Mạch (lần/phút)
    respiratory_rate INT,       -- Nhịp thở (lần/phút)
    bp_systolic INT,            -- Huyết áp tâm thu (mmHg) - Số trên (ví dụ 120)
    bp_diastolic INT,           -- Huyết áp tâm trương (mmHg) - Số dưới (ví dụ 80)
    sp_o2 NUMERIC(5,2),         -- Nồng độ oxy trong máu (%) - Tùy chọn

    final_icd_code VARCHAR(10) REFERENCES ref_icd10(icd_code),
    doctor_conclusion TEXT,
	  deleted_at TIMESTAMPTZ
); -- Done

CREATE TABLE queue_tickets (
    ticket_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    encounter_id UUID REFERENCES medical_encounters(encounter_id),
    room_id INT NOT NULL REFERENCES org_rooms(room_id),
    ticket_type VARCHAR(20) NOT NULL CHECK (ticket_type IN ('REGISTRATION', 'CONSULTATION', 'SERVICE')),
    display_number INT NOT NULL,
    source VARCHAR(20) DEFAULT 'WALKIN' CHECK (source IN ('ONLINE', 'WALKIN')),
    status VARCHAR(20) NOT NULL DEFAULT 'WAITING' CHECK (status IN ('WAITING', 'CALLED', 'IN_PROGRESS', 'COMPLETED', 'SKIPPED')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    called_at TIMESTAMPTZ,
    started_at TIMESTAMPTZ,
    service_ids INT[],
    completed_at TIMESTAMPTZ
); -- Done

-- Index cho mảng service_ids
CREATE INDEX idx_queue_tickets_service_ids ON queue_tickets USING GIN(service_ids);

-- BẢNG DỊCH VỤ & KẾT QUẢ
CREATE TABLE ref_icd10 (
    icd_code VARCHAR(10) PRIMARY KEY,
    name_vi VARCHAR(500) NOT NULL,
    name_en VARCHAR(500),
    parent_code VARCHAR(10) REFERENCES ref_icd10(icd_code),
    level INT,
    is_leaf BOOLEAN DEFAULT FALSE,
    active BOOLEAN DEFAULT TRUE
); -- Done

CREATE TABLE ref_service_categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(255) NOT NULL,
    parent_id INT REFERENCES ref_service_categories(category_id),
    is_system_root BOOLEAN DEFAULT FALSE
); -- Done

CREATE TABLE ref_services (
    service_id SERIAL PRIMARY KEY,
    category_id INT REFERENCES ref_service_categories(category_id),
    service_name VARCHAR(255) NOT NULL,
    unit_price DECIMAL(15,2),
    result_input_type VARCHAR(50) CHECK (result_input_type IN ('NUMERIC', 'TEXT'))
); -- Done

CREATE TABLE room_services (
    room_id INT REFERENCES org_rooms(room_id),
    service_id INT REFERENCES ref_services(service_id),
    PRIMARY KEY (room_id, service_id)
); -- Done

CREATE TABLE ref_lab_indicators (
    indicator_id SERIAL PRIMARY KEY,
    indicator_code VARCHAR(50),
    indicator_name VARCHAR(200),
    unit VARCHAR(50),
    ref_min_male DECIMAL(10,4), ref_max_male DECIMAL(10,4),
    ref_min_female DECIMAL(10,4), ref_max_female DECIMAL(10,4)
); -- Done

CREATE TABLE rel_service_indicators (
    service_id INT REFERENCES ref_services(service_id),
    indicator_id INT REFERENCES ref_lab_indicators(indicator_id),
    sort_order INT,
    PRIMARY KEY (service_id, indicator_id)
); -- Done

CREATE TABLE service_requests (
    request_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    encounter_id UUID REFERENCES medical_encounters(encounter_id),
    requesting_doctor_id UUID REFERENCES staff_profiles(staff_id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    payment_status VARCHAR(50) DEFAULT 'UNPAID' CHECK (payment_status IN ('UNPAID', 'PARTIALLY_PAID', 'PAID', 'CANCELLED')),
    notes TEXT,
	  deleted_at TIMESTAMPTZ
); -- Done

CREATE TABLE service_request_items (
    item_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    request_id UUID REFERENCES service_requests(request_id),
    service_id INT REFERENCES ref_services(service_id),
); -- Done

CREATE TABLE service_results (
    result_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    request_item_id UUID REFERENCES service_request_items(item_id),
    technician_id UUID REFERENCES staff_profiles(staff_id),
    main_conclusion TEXT,
    report_body_html TEXT,
    is_abnormal BOOLEAN DEFAULT FALSE,
    result_time TIMESTAMPTZ DEFAULT NOW(),
	  deleted_at TIMESTAMPTZ
); -- Done

CREATE TABLE result_details_numeric (
    detail_id BIGSERIAL PRIMARY KEY,
    result_id UUID REFERENCES service_results(result_id),
    indicator_id INT REFERENCES ref_lab_indicators(indicator_id),
    value_measured DECIMAL(10,4),
    is_critical BOOLEAN DEFAULT FALSE
); -- Done

CREATE TABLE result_images (
    image_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    result_id UUID REFERENCES service_results(result_id),
    public_id VARCHAR(255),
    original_image_url VARCHAR(500) NOT NULL,
    file_name VARCHAR(255),
    file_size BIGINT,
    mime_type VARCHAR(100),
    uploaded_at TIMESTAMPTZ DEFAULT NOW(),
    uploaded_by UUID NOT NULL REFERENCES staff_profiles(staff_id)
);

CREATE TABLE annotation_projects (
    project_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    task_type VARCHAR(50) NOT NULL 
        CHECK (task_type IN (
            'CLASSIFICATION',
            'BOUNDING_BOX',
            'SEGMENTATION',
            'KEYPOINT',
            'OCR',
            'OTHER'
        )),
    is_active BOOLEAN DEFAULT TRUE,
    created_by UUID REFERENCES staff_profiles(staff_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
); -- Done

CREATE TABLE image_annotations (
    annotation_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    image_id UUID NOT NULL REFERENCES result_images(image_id),
    annotation_source VARCHAR(20) NOT NULL CHECK (annotation_source IN ('AI', 'HUMAN')),
    annotation_data JSONB NOT NULL,
    ai_model_name VARCHAR(100),
    ai_model_version VARCHAR(50),
    labeled_by UUID REFERENCES staff_profiles(staff_id),
    labeled_at TIMESTAMPTZ DEFAULT NOW(),
	reviewed_by UUID REFERENCES staff_profiles(staff_id),
    reviewed_at TIMESTAMPTZ,
	approved_by UUID REFERENCES staff_profiles(staff_id),
    approved_at TIMESTAMPTZ,
	annotation_status VARCHAR(20) DEFAULT 'IN_PROGRESS'
        CHECK (annotation_status IN (
            'IN_PROGRESS',
            'SUBMITTED',
            'APPROVED',
            'REJECTED',
            'DEPRECATED'
        )),
    rejection_reason TEXT,
    deprecation_reason TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
    
); -- Done

CREATE TABLE annotation_project_images (
    project_id UUID NOT NULL REFERENCES annotation_projects(project_id),
    image_id UUID NOT NULL REFERENCES result_images(image_id),

    added_by UUID REFERENCES staff_profiles(staff_id),
    added_at TIMESTAMPTZ DEFAULT NOW(),

    PRIMARY KEY (project_id, image_id)
); -- Done

-- BẢNG QUẢN LÝ KHO & THUỐC
CREATE TABLE ref_drug_categories (
    category_id SERIAL PRIMARY KEY,
    parent_id INT REFERENCES ref_drug_categories(category_id),
    category_code VARCHAR(20),          -- VD: "VI.1.a"
    category_name VARCHAR(255) NOT NULL -- VD: "Thuốc trị giun, sán đường ruột"
); -- Done

CREATE TABLE ref_drugs (
    drug_id SERIAL PRIMARY KEY,
    category_id INT REFERENCES ref_drug_categories(category_id),

    drug_name VARCHAR(255) NOT NULL,        -- Tên thuốc hiển thị: "Diazepam 5mg viên nén"
    active_ingredient VARCHAR(255),         -- Hoạt chất: "Diazepam"
    drug_code VARCHAR(50) UNIQUE,           -- Mã thuốc nội bộ (nếu cần)

    dosage_form VARCHAR(50),                -- Dạng bào chế: "VIEN_NEN", "TIEM", "DUNG_DICH", ...
    route VARCHAR(50),                      -- Đường dùng: "ORAL", "IV", "IM", "RECTAL", ...
    strength VARCHAR(50),                   -- Hàm lượng/nồng độ: "5mg", "10mg/ml", ...
    unit_name VARCHAR(50),                  -- Đơn vị xuất/kê: "viên", "ống", "lọ", "ml"

    reorder_level INT,                      -- Ngưỡng tồn tối thiểu để cảnh báo nhập
	unit_price DECIMAL(10,2),
	quantity INT,
    is_active BOOLEAN DEFAULT TRUE
); -- Done

CREATE TABLE drug_imports (
    import_id SERIAL PRIMARY KEY,
    import_date DATE NOT NULL DEFAULT CURRENT_DATE,
    total_amount DECIMAL(15,2),             -- Tổng tiền hóa đơn (nếu cần)
    invoice_number VARCHAR(100),            -- Số hóa đơn nhà cung cấp
    imported_by UUID REFERENCES staff_profiles(staff_id), -- Nhân viên nhập kho
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
); -- Done

CREATE TABLE drug_import_details (
    import_detail_id SERIAL PRIMARY KEY,
    import_id INT NOT NULL REFERENCES drug_imports(import_id),

    drug_id INT NOT NULL REFERENCES ref_drugs(drug_id),
    quantity INT NOT NULL,                  -- Số lượng nhập
    unit_price DECIMAL(10,2) NOT NULL       -- Giá nhập một đơn vị
); -- Done


-- Gợi ý: quantity_current ban đầu = quantity của drug_import_details
-- Sau đó trừ dần khi xuất kho / cấp phát.

CREATE TABLE prescriptions (
    prescription_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    encounter_id UUID REFERENCES medical_encounters(encounter_id),

    prescribing_doctor_id UUID REFERENCES staff_profiles(staff_id),     -- Bác sĩ kê đơn
    dispensing_pharmacist_id UUID REFERENCES staff_profiles(staff_id),  -- Dược sĩ bốc thuốc

    status VARCHAR(20) DEFAULT 'DRAFT'
        CHECK (status IN ('DRAFT','ISSUED','DISPENSED','CANCELLED')),

    created_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
); -- DONE

CREATE TABLE prescription_details (
    detail_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    prescription_id UUID REFERENCES prescriptions(prescription_id),

    drug_id INT REFERENCES ref_drugs(drug_id),
    quantity INT CHECK (quantity > 0),
    usage_note TEXT                             -- Cách dùng: "1 viên x 2 lần/ngày sau ăn"
); -- Done

-- BẢNG TÀI CHÍNH & NHÂN SỰ
CREATE TABLE invoices (
    invoice_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    encounter_id UUID REFERENCES medical_encounters(encounter_id),
    cashier_id UUID REFERENCES staff_profiles(staff_id),
    total_amount DECIMAL(15,2),
	status VARCHAR(20) NOT NULL DEFAULT 'UNPAID'
        CHECK (status IN ('DRAFT', 'UNPAID', 'PARTIAL', 'PAID', 'CANCELLED')),
	created_at TIMESTAMPTZ DEFAULT NOW(),
    payment_time TIMESTAMPTZ, -- có thể set = lần thanh toán cuối cùng / khi đủ tiền
	deleted_at TIMESTAMPTZ
); -- Done

CREATE TABLE invoice_items (
    invoice_item_id BIGSERIAL PRIMARY KEY,
    invoice_id UUID NOT NULL REFERENCES invoices(invoice_id),

    item_type VARCHAR(20) NOT NULL CHECK (item_type IN ('CONSULTATION', 'SERVICE', 'DRUG', 'OTHER')),

    -- Nếu là dịch vụ CLS
    service_item_id UUID REFERENCES service_request_items(item_id),

    -- Nếu là thuốc
    prescription_detail_id UUID REFERENCES prescription_details(detail_id),

    description TEXT NOT NULL,              -- Tên in trên bill
    quantity INT NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(15,2) NOT NULL,
    line_amount DECIMAL(15,2) NOT NULL -- line_amount=quantity×unit_price
); -- Done

CREATE TABLE ref_payment_methods (
    payment_method_code VARCHAR(20) PRIMARY KEY,  -- 'CASH', 'BANK', 'CARD', 'MOMO', 'ZALO', ...
    method_name VARCHAR(100) NOT NULL,           -- "Tiền mặt", "Chuyển khoản ngân hàng", ...
    is_active BOOLEAN DEFAULT TRUE
); -- Done

CREATE TABLE invoice_payments (
    payment_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    invoice_id UUID NOT NULL REFERENCES invoices(invoice_id),

    payment_method_code VARCHAR(20) NOT NULL
        REFERENCES ref_payment_methods(payment_method_code),

    amount DECIMAL(15,2) NOT NULL CHECK (amount > 0),
    paid_at TIMESTAMPTZ DEFAULT NOW(),

    transaction_ref VARCHAR(100),   -- mã giao dịch ngân hàng / POS / Momo...
    notes TEXT	-- CHỈ CON NGƯỜI GHI
);

ALTER TABLE invoice_items
ADD CONSTRAINT chk_invoice_items_link
CHECK (
   (item_type = 'SERVICE' AND service_item_id IS NOT NULL AND prescription_detail_id IS NULL)
OR (item_type = 'DRUG' AND prescription_detail_id IS NOT NULL AND service_item_id IS NULL)
OR (item_type = 'CONSULTATION' AND service_item_id IS NULL AND prescription_detail_id IS NULL)
OR (item_type = 'OTHER')
); -- Done

-- BẢNG HỆ THỐNG
CREATE TABLE system_notifications (
    notification_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES staff_profiles(staff_id),
    title VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    notification_type VARCHAR(20) DEFAULT 'SYSTEM' CHECK (notification_type IN ('SYSTEM', 'APPOINTMENT', 'URGENT', 'LEAVE', 'PAYROLL', 'TASK')),
    is_read BOOLEAN DEFAULT FALSE,
    is_important BOOLEAN DEFAULT FALSE,
	sender_id UUID REFERENCES staff_profiles(staff_id), -- Người gửi (NULL nếu là System tự gửi)
    sender_name VARCHAR(100) DEFAULT 'Hệ thống',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    read_at TIMESTAMPTZ,
    is_deleted BOOLEAN DEFAULT FALSE
); -- Done

CREATE INDEX idx_notifications_user_read ON system_notifications(user_id, is_read, created_at DESC);

CREATE TABLE system_config (
    config_id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value VARCHAR(500) NOT NULL,
    config_type VARCHAR(50) DEFAULT 'GENERAL',
    description TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    updated_by UUID REFERENCES staff_profiles(staff_id)
); -- Done

CREATE TABLE system_audit_logs (
    log_id BIGSERIAL PRIMARY KEY,
    user_id UUID,
    action_type VARCHAR(50),
    table_name VARCHAR(50),
    record_id VARCHAR(50),
    old_value JSONB,
    new_value JSONB,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
); -- Done

CREATE UNIQUE INDEX uq_sys_users_username_active 
ON sys_users(username) 
WHERE deleted_at IS NULL;

CREATE UNIQUE INDEX uq_patient_profiles_cccd_active 
ON patient_profiles(cccd) 
WHERE deleted_at IS NULL;